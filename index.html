<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼å½“ åœ¨åº«ç®¡ç†ãƒ»å—ã‘å–ã‚Šã‚µãƒ¼ãƒ“ã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .bento-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .bento-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        /* Modal styles */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">ç¤¾å†…å¼å½“äº‰å¥ªæˆ¦ï¼</h1>
            <p class="text-gray-600 mt-2">ä»Šæ—¥ã®å¼å½“ã¯ãªã‚“ã ã‚ã†ï¼Ÿãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åœ¨åº«ã‚’ãƒã‚§ãƒƒã‚¯ï¼</p>
        </header>

        <!-- ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ« -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ«</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="bento-name" class="block text-sm font-medium text-gray-700">å¼å½“ã®åå‰</label>
                    <input type="text" id="bento-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="ä¾‹ï¼šç‰¹è£½ã‹ã‚‰ã‚ã’å¼å½“">
                </div>
                <div>
                    <label for="bento-stock" class="block text-sm font-medium text-gray-700">å…¥è·å€‹æ•°</label>
                    <input type="number" id="bento-stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="ä¾‹ï¼š5">
                </div>
                <button id="register-bento-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
                    ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
             <p class="text-xs text-gray-500 mt-2">â€» ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®æ„æ€è¡¨ç¤ºã‚„ç¢ºå®šè€…ãƒªã‚¹ãƒˆãŒã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šåœ¨åº«ã¨æ„æ€è¡¨ç¤º -->
            <div class="lg:col-span-2">
                <!-- åœ¨åº«æƒ…å ± -->
                <div id="bento-info-card" class="bento-card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2" id="current-bento-name">å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
                    <div class="flex items-baseline">
                        <p class="text-5xl font-extrabold text-blue-600" id="current-bento-stock">0</p>
                        <p class="ml-2 text-xl text-gray-600">å€‹</p>
                    </div>
                </div>

                <!-- æ„æ€è¡¨ç¤ºãƒ‘ãƒãƒ« -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">å¼å½“ã€é£Ÿã¹ãŸã„äººã„ã‚‹ï¼Ÿ (æ„æ€è¡¨ç¤º)</h3>
                    <p id="system-message" class="text-sm text-center p-3 mb-4 bg-yellow-100 text-yellow-800 rounded-lg">å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
                    <div id="wish-list" class="space-y-3">
                        <!-- JSã§ç¤¾å“¡ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šç¢ºå®šè€…ã¨å±¥æ­´ -->
            <div>
                <!-- ç¢ºå®šè€…ãƒªã‚¹ãƒˆ -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">ğŸ‰ æœ¬æ—¥ã®å¼å½“GETçµ„</h3>
                    <div id="takers-list" class="space-y-3">
                        <p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>

                <!-- ç´¯è¨ˆãƒ»å±¥æ­´ -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">ğŸ† å¼å½“ç²å¾—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <div id="stats-list" class="space-y-2 mb-6">
                        <!-- JSã§ç´¯è¨ˆæ•°ã‚’ç”Ÿæˆ -->
                    </div>
                    <h3 class="text-xl font-bold mb-4 border-t pt-4">å—ã‘å–ã‚Šå±¥æ­´</h3>
                    <div id="history-list" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                         <p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; <span id="year"></span> ç¤¾å†…å¼å½“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>
    
    <!-- Modal for notifications -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div id="modal-content" class="relative mx-auto p-5 border w-11/12 md:max-w-md shadow-lg rounded-md bg-white modal-enter">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">é€šçŸ¥</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-600"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, writeBatch, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        
        // ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD6atYGL6U4a6-20qz_g1NCmRKwfA8aEds",
            authDomain: "bento-app-2025.firebaseapp.com",
            projectId: "bento-app-2025",
            storageBucket: "bento-app-2025.appspot.com",
            messagingSenderId: "157224537828",
            appId: "1:157224537828:web:a8388a63eff8e451bba6f1",
            measurementId: "G-PBBMCG5L3Y"
        };

        // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bento-app-default';

        // --- å®šæ•°å®šç¾© ---
        const MEMBERS = [
            { id: 'kono', name: 'æ²³é‡', priority: 1 },
            { id: 'matsumura', name: 'æ¾æ‘', priority: 2 },
            { id: 'suzuki', name: 'éˆ´æœ¨', priority: 3 },
            { id: 'ito', name: 'ä¼Šè—¤', priority: 4 },
            { id: 'hori', name: 'å €', priority: 5 },
            { id: 'kasuga', name: 'æ˜¥æ—¥', priority: 6 },
            { id: 'miyake', name: 'ä¸‰å®…', priority: 7 },
        ];

        // --- DOMè¦ç´  ---
        const bentoNameInput = document.getElementById('bento-name');
        const bentoStockInput = document.getElementById('bento-stock');
        const registerBentoBtn = document.getElementById('register-bento-btn');
        const currentBentoName = document.getElementById('current-bento-name');
        const currentBentoStock = document.getElementById('current-bento-stock');
        const wishList = document.getElementById('wish-list');
        const takersList = document.getElementById('takers-list');
        const statsList = document.getElementById('stats-list');
        const historyList = document.getElementById('history-list');
        const systemMessage = document.getElementById('system-message');
        const bentoInfoCard = document.getElementById('bento-info-card');
        const customModal = document.getElementById('custom-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let currentBento = null;
        let wishes = new Map();
        let takers = new Map();
        let determinationInProgress = false;

        // --- Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ ---
        const bentoDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'bento/current');
        const wishesCol = collection(db, 'artifacts', appId, 'public', 'data', 'wishes');
        const takersCol = collection(db, 'artifacts', appId, 'public', 'data', 'takers');
        const statsCol = collection(db, 'artifacts', appId, 'public', 'data', 'stats');
        const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ---
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
            modalContent.classList.remove('modal-leave', 'modal-leave-active');
            modalContent.classList.add('modal-enter-active');
        }

        function hideModal() {
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                customModal.classList.add('hidden');
            }, 300);
        }

        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        function setupRealtimeListeners() {
            onSnapshot(bentoDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBento = { id: docSnap.id, ...docSnap.data() };
                    updateBentoInfoUI();
                    bentoInfoCard.classList.add('pulse');
                    setTimeout(() => bentoInfoCard.classList.remove('pulse'), 2000);
                } else {
                    currentBento = null;
                    resetUI();
                }
                updateWishListUI();
            });

            onSnapshot(wishesCol, (snapshot) => {
                wishes.clear();
                snapshot.docs.forEach(doc => wishes.set(doc.id, doc.data()));
                updateWishListUI();
                determineTakers();
            });

            onSnapshot(takersCol, (snapshot) => {
                takers.clear();
                snapshot.docs.forEach(doc => takers.set(doc.id, doc.data()));
                updateTakersListUI();
            });
            
            onSnapshot(statsCol, (snapshot) => {
                const stats = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                updateStatsListUI(stats);
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (snapshot) => {
                const history = snapshot.docs.map(doc => doc.data()).sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                updateHistoryListUI(history);
            });
        }

        // --- UIæ›´æ–°é–¢æ•° ---
        function updateBentoInfoUI() {
            if (currentBento) {
                currentBentoName.textContent = currentBento.name;
                currentBentoStock.textContent = currentBento.current_stock;
                systemMessage.textContent = 'é£Ÿã¹ãŸã„äººã¯æ„æ€è¡¨ç¤ºã‚’ã—ã¦ãã ã•ã„ï¼';
                systemMessage.classList.replace('bg-yellow-100', 'bg-green-100');
                systemMessage.classList.replace('text-yellow-800', 'text-green-800');
            }
        }
        
        function resetUI() {
            currentBentoName.textContent = 'å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
            currentBentoStock.textContent = '0';
            systemMessage.textContent = 'å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
            systemMessage.classList.replace('bg-green-100', 'bg-yellow-100');
            systemMessage.classList.replace('text-green-800', 'text-yellow-800');
            wishList.innerHTML = '';
            takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
        }

        function updateWishListUI() {
            wishList.innerHTML = '';
            const areTakersDecided = takers.size > 0;
            const noBento = !currentBento || currentBento.current_stock <= 0;

            MEMBERS.forEach(member => {
                const wishData = wishes.get(member.id);
                const li = document.createElement('div');
                li.className = `p-3 rounded-lg flex items-center justify-between transition`;

                let statusHtml = '';
                let buttonHtml = '';

                if (wishData) {
                    if (wishData.status === 'wishing') {
                        li.classList.add('bg-blue-100');
                        statusHtml = `<span class="text-sm font-bold text-blue-600">å¸Œæœ›è¡¨æ˜æ¸ˆã¿</span>`;
                    } else if (wishData.status === 'not_wishing') {
                        li.classList.add('bg-gray-200');
                        statusHtml = `<span class="text-sm font-bold text-gray-500">ä¸è¦</span>`;
                    }
                } else {
                    li.classList.add('bg-gray-100');
                }

                if (!wishData && !areTakersDecided && !noBento) {
                    buttonHtml = `
                        <div class="flex space-x-2">
                            <button data-id="${member.id}" class="wish-btn bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-green-600 btn">å¸Œæœ›ã™ã‚‹</button>
                            <button data-id="${member.id}" class="no-wish-btn bg-gray-400 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-gray-500 btn">ä¸è¦</button>
                        </div>
                    `;
                }

                li.innerHTML = `
                    <span class="font-medium">${member.name}</span>
                    <div class="flex-grow"></div>
                    ${statusHtml}
                    ${buttonHtml}
                `;
                wishList.appendChild(li);
            });
        }
        
        function updateTakersListUI() {
            takersList.innerHTML = '';
            if (takers.size === 0) {
                takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const sortedTakers = Array.from(takers.entries()).sort((a,b) => a[1].priority - b[1].priority);
            
            sortedTakers.forEach(([id, takerData]) => {
                const div = document.createElement('div');
                let statusOrButtonHtml = '';

                if (takerData.taken) {
                    div.className = 'p-3 rounded-lg flex items-center justify-between bg-green-100 text-gray-800';
                    statusOrButtonHtml = `<span class="text-sm font-bold text-green-800">å—ã‘å–ã‚Šå®Œäº†</span>`;
                } else {
                    div.className = 'p-3 rounded-lg flex items-center justify-between bg-yellow-100';
                    statusOrButtonHtml = `<button data-id="${id}" class="take-btn bg-orange-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-orange-600 btn">æœªå—ã‘å–ã‚Š</button>`;
                }

                div.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-800">${takerData.name}</span>
                    </div>
                    ${statusOrButtonHtml}
                `;
                takersList.appendChild(div);
            });
        }

        function updateStatsListUI(stats) {
            statsList.innerHTML = '';
            if (!stats || stats.length === 0) {
                 statsList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚å—ã‘å–ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                 return;
            }

            const sortedStats = stats.sort((a,b) => b.total_taken - a.total_taken);
            sortedStats.forEach(stat => {
                 const member = MEMBERS.find(m => m.id === stat.id);
                 if (member) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span>${member.name}</span>
                        <span class="font-bold bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${stat.total_taken} å›</span>
                    `;
                    statsList.appendChild(div);
                }
            });
        }
        
        function updateHistoryListUI(history) {
             historyList.innerHTML = '';
             if (!history || history.length === 0) {
                 historyList.innerHTML = '<p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                 return;
             }
             history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-1.5 bg-gray-50 rounded';
                const date = item.timestamp.toDate().toLocaleString('ja-JP');
                div.textContent = `${date}: ${item.name}ã•ã‚“ãŒ${item.bento_name}ã‚’å—ã‘å–ã‚Š`;
                historyList.appendChild(div);
             });
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
        registerBentoBtn.addEventListener('click', async () => {
            const name = bentoNameInput.value.trim();
            const stock = parseInt(bentoStockInput.value, 10);

            if (!name || isNaN(stock) || stock <= 0) {
                showModal('æœ‰åŠ¹ãªå¼å½“ã®åå‰ã¨å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const batch = writeBatch(db);
            wishes.forEach((val, key) => batch.delete(doc(wishesCol, key)));
            takers.forEach((val, key) => batch.delete(doc(takersCol, key)));
            
            const newBentoData = {
                name: name,
                initial_stock: stock,
                current_stock: stock,
                timestamp: new Date()
            };
            batch.set(bentoDocRef, newBentoData);

            await batch.commit();
            
            bentoNameInput.value = '';
            bentoStockInput.value = '';
            showModal(`${name}ã‚’${stock}å€‹ã§ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
        });

        wishList.addEventListener('click', async (e) => {
            const target = e.target;
            const userId = target.dataset.id;
            if (!userId) return;

            const member = MEMBERS.find(m => m.id === userId);
            if (!member) return;
            
            const buttonContainer = target.parentElement;

            if (target.classList.contains('wish-btn') || target.classList.contains('no-wish-btn')) {
                buttonContainer.innerHTML = '<span class="text-sm text-gray-500">å‡¦ç†ä¸­...</span>';
                const status = target.classList.contains('wish-btn') ? 'wishing' : 'not_wishing';
                await setDoc(doc(wishesCol, userId), {
                    name: member.name,
                    priority: member.priority,
                    status: status,
                    timestamp: new Date()
                });
            }
        });
        
        takersList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('take-btn')) {
                const takerId = e.target.dataset.id;
                e.target.disabled = true; // Double-click prevention
                
                try {
                    await runTransaction(db, async (transaction) => {
                        // --- å…¨ã¦ã®èª­ã¿å–ã‚Šã‚’å…ˆã«å®Ÿè¡Œ ---
                        const bentoSnap = await transaction.get(bentoDocRef);
                        const takerSnap = await transaction.get(doc(takersCol, takerId));
                        const statDocRef = doc(statsCol, takerId);
                        const statSnap = await transaction.get(statDocRef);

                        // --- èª­ã¿å–ã‚Šå¾Œã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ ---
                        if (!bentoSnap.exists() || bentoSnap.data().current_stock <= 0) {
                            throw "å¼å½“ã®åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                        }
                        if (!takerSnap.exists() || takerSnap.data().taken) {
                             throw "ã™ã§ã«å—ã‘å–ã‚Šæ¸ˆã¿ã‹ã€å¯¾è±¡è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                        }

                        // --- å…¨ã¦ã®æ›¸ãè¾¼ã¿ã‚’å¾Œã«å®Ÿè¡Œ ---
                        // 1. åœ¨åº«ã‚’æ¸›ã‚‰ã™
                        transaction.update(bentoDocRef, { current_stock: bentoSnap.data().current_stock - 1 });
                        
                        // 2. å—ã‘å–ã‚Šæ¸ˆã¿ã«ã™ã‚‹
                        transaction.update(doc(takersCol, takerId), { taken: true });

                        // 3. çµ±è¨ˆã‚’æ›´æ–°
                        const newTotal = (statSnap.exists() ? statSnap.data().total_taken : 0) + 1;
                        transaction.set(statDocRef, { total_taken: newTotal, name: takerSnap.data().name }, { merge: true });

                        // 4. å±¥æ­´ã«è¿½åŠ 
                        const historyDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'history'));
                        transaction.set(historyDocRef, {
                            userId: takerId,
                            name: takerSnap.data().name,
                            bento_name: bentoSnap.data().name,
                            timestamp: new Date()
                        });
                    });
                } catch (error) {
                    console.error("å—ã‘å–ã‚Šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ", error);
                    showModal("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + error);
                }
            }
        });

        modalCloseBtn.addEventListener('click', hideModal);
        customModal.addEventListener('click', (e) => {
            if (e.target === customModal) {
                hideModal();
            }
        });

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function determineTakers() {
            if (determinationInProgress || !currentBento || takers.size > 0) {
                return;
            }

            const totalVotes = wishes.size;
            const totalMembers = MEMBERS.length;

            // å…¨å“¡ã®æŠ•ç¥¨ãŒå®Œäº†ã—ãŸå ´åˆã®ã¿ã€å½“é¸è€…æ±ºå®šå‡¦ç†ã«é€²ã‚€
            if (totalVotes === totalMembers) {
                determinationInProgress = true;
                
                try {
                    const stock = currentBento.initial_stock;

                    const wishingMembers = Array.from(wishes.values())
                        .filter(w => w.status === 'wishing')
                        .sort((a, b) => a.priority - b.priority);

                    const newTakers = wishingMembers.slice(0, stock);

                    if (newTakers.length > 0) {
                        const batch = writeBatch(db);
                        newTakers.forEach(taker => {
                            const member = MEMBERS.find(m => m.priority === taker.priority);
                            if (member) {
                                batch.set(doc(takersCol, member.id), {
                                    name: member.name,
                                    priority: member.priority,
                                    taken: false,
                                    timestamp: new Date()
                                });
                            }
                        });
                        await batch.commit();
                        systemMessage.textContent = 'å…¨å“¡ã®æ„æ€è¡¨ç¤ºãŒå®Œäº†ã—ã€GETçµ„ãŒç¢ºå®šã—ã¾ã—ãŸï¼';
                    } else {
                         systemMessage.textContent = 'å…¨å“¡ãŒæ„æ€è¡¨ç¤ºã—ã¾ã—ãŸãŒã€å¸Œæœ›è€…ã¯ã„ã¾ã›ã‚“ã§ã—ãŸã€‚';
                    }
                } catch (error) {
                    console.error("ç¢ºå®šè€…ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—:", error);
                    showModal("ç¢ºå®šè€…ã®æ±ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                } finally {
                    determinationInProgress = false;
                }
            } else if (currentBento && totalVotes > 0) {
                const remainingVotes = totalMembers - totalVotes;
                systemMessage.textContent = `ã‚ã¨${remainingVotes}äººã®æ„æ€è¡¨ç¤ºå¾…ã¡ã§ã™...`;
            }
        }

        // --- åˆæœŸåŒ– ---
        window.onload = () => {
            setupRealtimeListeners();
        };

    </script>
</body>
</html>

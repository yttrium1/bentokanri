<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼å½“ åœ¨åº«ç®¡ç†ãƒ»å—ã‘å–ã‚Šã‚µãƒ¼ãƒ“ã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .bento-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .bento-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">ç¤¾å†…å¼å½“äº‰å¥ªæˆ¦ï¼</h1>
            <p class="text-gray-600 mt-2">ä»Šæ—¥ã®å¼å½“ã¯ãªã‚“ã ã‚ã†ï¼Ÿãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åœ¨åº«ã‚’ãƒã‚§ãƒƒã‚¯ï¼</p>
        </header>

        <!-- ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ« -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ«</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="bento-name" class="block text-sm font-medium text-gray-700">å¼å½“ã®åå‰</label>
                    <input type="text" id="bento-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="ä¾‹ï¼šç‰¹è£½ã‹ã‚‰ã‚ã’å¼å½“">
                </div>
                <div>
                    <label for="bento-stock" class="block text-sm font-medium text-gray-700">å…¥è·å€‹æ•°</label>
                    <input type="number" id="bento-stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="ä¾‹ï¼š5">
                </div>
                <button id="register-bento-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
                    ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
             <p class="text-xs text-gray-500 mt-2">â€» ç™»éŒ²ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®æ„æ€è¡¨ç¤ºã‚„ç¢ºå®šè€…ãƒªã‚¹ãƒˆãŒã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šåœ¨åº«ã¨æ„æ€è¡¨ç¤º -->
            <div class="lg:col-span-2">
                <!-- åœ¨åº«æƒ…å ± -->
                <div id="bento-info-card" class="bento-card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2" id="current-bento-name">å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
                    <div class="flex items-baseline">
                        <p class="text-5xl font-extrabold text-blue-600" id="current-bento-stock">0</p>
                        <p class="ml-2 text-xl text-gray-600">å€‹</p>
                    </div>
                </div>

                <!-- æ„æ€è¡¨ç¤ºãƒ‘ãƒãƒ« -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">å¼å½“ã€é£Ÿã¹ãŸã„äººã„ã‚‹ï¼Ÿ (æ„æ€è¡¨ç¤º)</h3>
                    <p id="system-message" class="text-sm text-center p-3 mb-4 bg-yellow-100 text-yellow-800 rounded-lg">å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
                    <div id="wish-list" class="space-y-3">
                        <!-- JSã§ç¤¾å“¡ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šç¢ºå®šè€…ã¨å±¥æ­´ -->
            <div>
                <!-- ç¢ºå®šè€…ãƒªã‚¹ãƒˆ -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">ğŸ‰ æœ¬æ—¥ã®å¼å½“GETçµ„</h3>
                    <div id="takers-list" class="space-y-3">
                        <p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>

                <!-- ç´¯è¨ˆãƒ»å±¥æ­´ -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">ğŸ† å¼å½“ç²å¾—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <div id="stats-list" class="space-y-2 mb-6">
                        <!-- JSã§ç´¯è¨ˆæ•°ã‚’ç”Ÿæˆ -->
                    </div>
                    <h3 class="text-xl font-bold mb-4 border-t pt-4">å—ã‘å–ã‚Šå±¥æ­´</h3>
                    <div id="history-list" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                         <p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; <span id="year"></span> ç¤¾å†…å¼å½“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>
    
    <script type="module">
        // Firebaseè¨­å®šï¼ˆå®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
        // ã“ã®ã‚³ãƒ¼ãƒ‰ã¯Canvasç’°å¢ƒã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
        // ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ã™å ´åˆã¯ã€ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šæƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bento-app-default';

        // Firebase ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- å®šæ•°å®šç¾© ---
        const MEMBERS = [
            { id: 'kono', name: 'æ²³é‡', priority: 1 },
            { id: 'matsumura', name: 'æ¾æ‘', priority: 2 },
            { id: 'suzuki', name: 'éˆ´æœ¨', priority: 3 },
            { id: 'ito', name: 'ä¼Šè—¤', priority: 4 },
            { id: 'hori', name: 'å €', priority: 5 },
            { id: 'kasuga', name: 'æ˜¥æ—¥', priority: 6 },
            { id: 'miyake', name: 'ä¸‰å®…', priority: 7 },
        ];

        // --- DOMè¦ç´  ---
        const bentoNameInput = document.getElementById('bento-name');
        const bentoStockInput = document.getElementById('bento-stock');
        const registerBentoBtn = document.getElementById('register-bento-btn');
        const currentBentoName = document.getElementById('current-bento-name');
        const currentBentoStock = document.getElementById('current-bento-stock');
        const wishList = document.getElementById('wish-list');
        const takersList = document.getElementById('takers-list');
        const statsList = document.getElementById('stats-list');
        const historyList = document.getElementById('history-list');
        const systemMessage = document.getElementById('system-message');
        const bentoInfoCard = document.getElementById('bento-info-card');
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let currentBento = null;
        let wishes = new Map();
        let takers = new Map();
        let determinationInProgress = false;

        // --- Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ ---
        const bentoCol = collection(db, 'artifacts', appId, 'public', 'data', 'bento');
        const wishesCol = collection(db, 'artifacts', appId, 'public', 'data', 'wishes');
        const takersCol = collection(db, 'artifacts', appId, 'public', 'data', 'takers');
        const statsCol = collection(db, 'artifacts', appId, 'public', 'data', 'stats');
        const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
        const bentoDocRef = doc(bentoCol, 'current');

        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        function setupRealtimeListeners() {
            // å¼å½“æƒ…å ±
            onSnapshot(bentoDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBento = { id: docSnap.id, ...docSnap.data() };
                    updateBentoInfoUI();
                    bentoInfoCard.classList.add('pulse');
                    setTimeout(() => bentoInfoCard.classList.remove('pulse'), 2000);
                } else {
                    currentBento = null;
                    resetUI();
                }
                updateWishListUI(); // å¼å½“ã®çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰æ„æ€è¡¨ç¤ºUIã‚‚æ›´æ–°
            });

            // æ„æ€è¡¨ç¤º
            onSnapshot(wishesCol, (snapshot) => {
                wishes.clear();
                snapshot.docs.forEach(doc => wishes.set(doc.id, doc.data()));
                updateWishListUI();
                determineTakers();
            });

            // ç¢ºå®šè€…
            onSnapshot(takersCol, (snapshot) => {
                takers.clear();
                snapshot.docs.forEach(doc => takers.set(doc.id, doc.data()));
                updateTakersListUI();
            });
            
            // çµ±è¨ˆ
            onSnapshot(statsCol, (snapshot) => {
                const stats = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                updateStatsListUI(stats);
            });

            // å±¥æ­´
            onSnapshot(historyCol, (snapshot) => {
                const history = snapshot.docs.map(doc => doc.data()).sort((a,b) => b.timestamp - a.timestamp);
                updateHistoryListUI(history);
            });
        }

        // --- UIæ›´æ–°é–¢æ•° ---
        function updateBentoInfoUI() {
            if (currentBento) {
                currentBentoName.textContent = currentBento.name;
                currentBentoStock.textContent = currentBento.current_stock;
                systemMessage.textContent = 'é£Ÿã¹ãŸã„äººã¯ã€Œå¸Œæœ›ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼';
                systemMessage.classList.replace('bg-yellow-100', 'bg-green-100');
                 systemMessage.classList.replace('text-yellow-800', 'text-green-800');
            }
        }
        
        function resetUI() {
            currentBentoName.textContent = 'å¼å½“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
            currentBentoStock.textContent = '0';
            systemMessage.textContent = 'å¼å½“ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨æ„æ€è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
            systemMessage.classList.replace('bg-green-100', 'bg-yellow-100');
            systemMessage.classList.replace('text-green-800', 'text-yellow-800');
            wishList.innerHTML = '';
            takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
        }

        function updateWishListUI() {
            wishList.innerHTML = '';
            const areTakersDecided = takers.size > 0;
            const noBento = !currentBento || currentBento.current_stock <= 0;

            MEMBERS.forEach(member => {
                const hasWished = wishes.has(member.id);
                const li = document.createElement('div');
                li.className = `p-3 rounded-lg flex items-center justify-between transition ${hasWished ? 'bg-blue-100' : 'bg-gray-100'}`;
                li.innerHTML = `
                    <span class="font-medium">${member.name}</span>
                    ${hasWished ? '<span class="text-sm font-bold text-blue-600">å¸Œæœ›è¡¨æ˜æ¸ˆã¿</span>' : ''}
                    <button data-id="${member.id}" class="wish-btn bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-green-600 btn">å¸Œæœ›ã™ã‚‹</button>
                `;
                wishList.appendChild(li);

                const btn = li.querySelector('.wish-btn');
                if (hasWished || areTakersDecided || noBento) {
                    btn.disabled = true;
                    btn.classList.add('hidden');
                }
            });
        }
        
        function updateTakersListUI() {
            takersList.innerHTML = '';
            if (takers.size === 0) {
                takersList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const sortedTakers = Array.from(takers.values()).sort((a,b) => a.priority - b.priority);
            
            sortedTakers.forEach(taker => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg flex items-center justify-between ${taker.taken ? 'bg-gray-200' : 'bg-yellow-100'}`;
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-800">${taker.name}</span>
                        ${taker.taken ? '<span class="text-xs ml-2 text-green-700">å—å–æ¸ˆ</span>' : ''}
                    </div>
                    <button data-id="${taker.id}" class="take-btn bg-orange-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-orange-600 btn">å—ã‘å–ã£ãŸ</button>
                `;
                takersList.appendChild(div);

                const btn = div.querySelector('.take-btn');
                if (taker.taken) {
                    btn.disabled = true;
                    btn.classList.add('hidden');
                }
            });
        }

        function updateStatsListUI(stats) {
            statsList.innerHTML = '';
            if (!stats || stats.length === 0) {
                 statsList.innerHTML = '<p class="text-gray-500">ã¾ã èª°ã‚‚å—ã‘å–ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>';
                 return;
            }

            const sortedStats = stats.sort((a,b) => b.total_taken - a.total_taken);
            sortedStats.forEach(stat => {
                 const member = MEMBERS.find(m => m.id === stat.id);
                 if (member) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span>${member.name}</span>
                        <span class="font-bold bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${stat.total_taken} å›</span>
                    `;
                    statsList.appendChild(div);
                }
            });
        }
        
        function updateHistoryListUI(history) {
             historyList.innerHTML = '';
             if (!history || history.length === 0) {
                 historyList.innerHTML = '<p class="text-gray-500">ã¾ã å—ã‘å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                 return;
             }
             history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-1.5 bg-gray-50 rounded';
                const date = new Date(item.timestamp.seconds * 1000).toLocaleString('ja-JP');
                div.textContent = `${date}: ${item.name}ã•ã‚“ãŒ${item.bento_name}ã‚’å—ã‘å–ã‚Š`;
                historyList.appendChild(div);
             });
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
        
        // å¼å½“ç™»éŒ²
        registerBentoBtn.addEventListener('click', async () => {
            const name = bentoNameInput.value.trim();
            const stock = parseInt(bentoStockInput.value, 10);

            if (!name || isNaN(stock) || stock <= 0) {
                alert('æœ‰åŠ¹ãªå¼å½“ã®åå‰ã¨å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤
            const batch = writeBatch(db);
            const wishesSnapshot = await getDoc(collection(db, 'artifacts', appId, 'public', 'data', 'wishes'));
            const takersSnapshot = await getDoc(collection(db, 'artifacts', appId, 'public', 'data', 'takers'));
            wishes.forEach((val, key) => batch.delete(doc(wishesCol, key)));
            takers.forEach((val, key) => batch.delete(doc(takersCol, key)));
            
            // æ–°ã—ã„å¼å½“æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
            const newBentoData = {
                name: name,
                initial_stock: stock,
                current_stock: stock,
                timestamp: new Date()
            };
            batch.set(bentoDocRef, newBentoData);

            await batch.commit();
            
            bentoNameInput.value = '';
            bentoStockInput.value = '';
            alert(`${name}ã‚’${stock}å€‹ã§ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
        });

        // æ„æ€è¡¨ç¤º
        wishList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('wish-btn')) {
                const userId = e.target.dataset.id;
                const member = MEMBERS.find(m => m.id === userId);
                if (member) {
                    e.target.disabled = true;
                    await setDoc(doc(wishesCol, userId), {
                        name: member.name,
                        priority: member.priority,
                        timestamp: new Date()
                    });
                }
            }
        });
        
        // å—ã‘å–ã‚Šç¢ºå®š
        takersList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('take-btn')) {
                const takerId = e.target.dataset.id;
                e.target.disabled = true;
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const bentoSnap = await transaction.get(bentoDocRef);
                        if (!bentoSnap.exists() || bentoSnap.data().current_stock <= 0) {
                            throw "å¼å½“ã®åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                        }
                        
                        const takerSnap = await transaction.get(doc(takersCol, takerId));
                        if (!takerSnap.exists() || takerSnap.data().taken) {
                             throw "ã™ã§ã«å—ã‘å–ã‚Šæ¸ˆã¿ã§ã™ã€‚";
                        }

                        // 1. åœ¨åº«ã‚’æ¸›ã‚‰ã™
                        const newStock = bentoSnap.data().current_stock - 1;
                        transaction.update(bentoDocRef, { current_stock: newStock });

                        // 2. Takerã‚’æ›´æ–° (taken: true)
                        transaction.update(doc(takersCol, takerId), { taken: true });

                        // 3. çµ±è¨ˆã‚’æ›´æ–°
                        const statDocRef = doc(statsCol, takerId);
                        const statSnap = await transaction.get(statDocRef);
                        const newTotal = (statSnap.exists() ? statSnap.data().total_taken : 0) + 1;
                        transaction.set(statDocRef, { total_taken: newTotal, name: takerSnap.data().name }, { merge: true });

                        // 4. å±¥æ­´ã«è¿½åŠ 
                        const historyDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'history')); // æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
                        transaction.set(historyDocRef, {
                            userId: takerId,
                            name: takerSnap.data().name,
                            bento_name: bentoSnap.data().name,
                            timestamp: new Date()
                        });
                    });
                    console.log("å—ã‘å–ã‚Šå‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚");
                } catch (error) {
                    console.error("å—ã‘å–ã‚Šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ", error);
                    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                }
            }
        });

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---

        async function determineTakers() {
            if (determinationInProgress || !currentBento || takers.size > 0 || wishes.size === 0) {
                return;
            }

            const stock = currentBento.initial_stock;
            const wishingMembers = Array.from(wishes.values()).sort((a,b) => a.priority - b.priority);

            if (wishingMembers.length >= stock) {
                determinationInProgress = true;
                const newTakers = wishingMembers.slice(0, stock);

                const batch = writeBatch(db);
                newTakers.forEach(taker => {
                    const member = MEMBERS.find(m => m.priority === taker.priority);
                    if(member){
                         batch.set(doc(takersCol, member.id), {
                            name: member.name,
                            priority: member.priority,
                            taken: false,
                            timestamp: new Date()
                        });
                    }
                });

                try {
                    await batch.commit();
                    console.log("ç¢ºå®šè€…ãŒæ±ºå®šã—ã¾ã—ãŸã€‚");
                    systemMessage.textContent = 'æœ¬æ—¥ã®å¼å½“GETçµ„ãŒç¢ºå®šã—ã¾ã—ãŸï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';
                } catch(error) {
                    console.error("ç¢ºå®šè€…ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—:", error);
                } finally {
                    determinationInProgress = false;
                }
            }
        }

        // --- åˆæœŸåŒ– ---
        window.onload = () => {
            setupRealtimeListeners();
        };

    </script>
</body>
</html>

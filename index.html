<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>弁当 在庫管理・受け取りサービス</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .bento-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .bento-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">社内弁当争奪戦！</h1>
            <p class="text-gray-600 mt-2">今日の弁当はなんだろう？リアルタイムで在庫をチェック！</p>
        </header>

        <!-- 管理者用パネル -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">管理者用パネル</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="bento-name" class="block text-sm font-medium text-gray-700">弁当の名前</label>
                    <input type="text" id="bento-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="例：特製からあげ弁当">
                </div>
                <div>
                    <label for="bento-stock" class="block text-sm font-medium text-gray-700">入荷個数</label>
                    <input type="number" id="bento-stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="例：5">
                </div>
                <button id="register-bento-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
                    登録・リセット
                </button>
            </div>
             <p class="text-xs text-gray-500 mt-2">※ 登録・リセットボタンを押すと、現在の意思表示や確定者リストがすべてリセットされます。</p>
        </div>

        <!-- メインコンテンツ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 左カラム：在庫と意思表示 -->
            <div class="lg:col-span-2">
                <!-- 在庫情報 -->
                <div id="bento-info-card" class="bento-card bg-white p-6 rounded-xl mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2" id="current-bento-name">弁当はまだ登録されていません</h2>
                    <div class="flex items-baseline">
                        <p class="text-5xl font-extrabold text-blue-600" id="current-bento-stock">0</p>
                        <p class="ml-2 text-xl text-gray-600">個</p>
                    </div>
                </div>

                <!-- 意思表示パネル -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">弁当、食べたい人いる？ (意思表示)</h3>
                    <p id="system-message" class="text-sm text-center p-3 mb-4 bg-yellow-100 text-yellow-800 rounded-lg">弁当が登録されると意思表示を開始できます。</p>
                    <div id="wish-list" class="space-y-3">
                        <!-- JSで社員リストを生成 -->
                    </div>
                </div>
            </div>

            <!-- 右カラム：確定者と履歴 -->
            <div>
                <!-- 確定者リスト -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-bold mb-4">🎉 本日の弁当GET組</h3>
                    <div id="takers-list" class="space-y-3">
                        <p class="text-gray-500">まだ誰も確定していません。</p>
                    </div>
                </div>

                <!-- 累計・履歴 -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">🏆 弁当獲得ランキング</h3>
                    <div id="stats-list" class="space-y-2 mb-6">
                        <!-- JSで累計数を生成 -->
                    </div>
                    <h3 class="text-xl font-bold mb-4 border-t pt-4">受け取り履歴</h3>
                    <div id="history-list" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                         <p class="text-gray-500">まだ受け取り履歴はありません。</p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; <span id="year"></span> 社内弁当管理システム</p>
        </footer>
    </div>
    
    <script type="module">
        // Firebase設定（実際の値に置き換えてください）
        // このコードはCanvas環境で動作するように設定されています。
        // ローカルで試す場合は、ご自身のFirebaseプロジェクトの設定情報を貼り付けてください。
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bento-app-default';

        // Firebase モジュールのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // アプリの初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 定数定義 ---
        const MEMBERS = [
            { id: 'kono', name: '河野', priority: 1 },
            { id: 'matsumura', name: '松村', priority: 2 },
            { id: 'suzuki', name: '鈴木', priority: 3 },
            { id: 'ito', name: '伊藤', priority: 4 },
            { id: 'hori', name: '堀', priority: 5 },
            { id: 'kasuga', name: '春日', priority: 6 },
            { id: 'miyake', name: '三宅', priority: 7 },
        ];

        // --- DOM要素 ---
        const bentoNameInput = document.getElementById('bento-name');
        const bentoStockInput = document.getElementById('bento-stock');
        const registerBentoBtn = document.getElementById('register-bento-btn');
        const currentBentoName = document.getElementById('current-bento-name');
        const currentBentoStock = document.getElementById('current-bento-stock');
        const wishList = document.getElementById('wish-list');
        const takersList = document.getElementById('takers-list');
        const statsList = document.getElementById('stats-list');
        const historyList = document.getElementById('history-list');
        const systemMessage = document.getElementById('system-message');
        const bentoInfoCard = document.getElementById('bento-info-card');
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- グローバル変数 ---
        let currentBento = null;
        let wishes = new Map();
        let takers = new Map();
        let determinationInProgress = false;

        // --- Firestoreコレクション参照 ---
        const bentoCol = collection(db, 'artifacts', appId, 'public', 'data', 'bento');
        const wishesCol = collection(db, 'artifacts', appId, 'public', 'data', 'wishes');
        const takersCol = collection(db, 'artifacts', appId, 'public', 'data', 'takers');
        const statsCol = collection(db, 'artifacts', appId, 'public', 'data', 'stats');
        const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
        const bentoDocRef = doc(bentoCol, 'current');

        // --- リアルタイムリスナー設定 ---
        function setupRealtimeListeners() {
            // 弁当情報
            onSnapshot(bentoDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBento = { id: docSnap.id, ...docSnap.data() };
                    updateBentoInfoUI();
                    bentoInfoCard.classList.add('pulse');
                    setTimeout(() => bentoInfoCard.classList.remove('pulse'), 2000);
                } else {
                    currentBento = null;
                    resetUI();
                }
                updateWishListUI(); // 弁当の状態が変わったら意思表示UIも更新
            });

            // 意思表示
            onSnapshot(wishesCol, (snapshot) => {
                wishes.clear();
                snapshot.docs.forEach(doc => wishes.set(doc.id, doc.data()));
                updateWishListUI();
                determineTakers();
            });

            // 確定者
            onSnapshot(takersCol, (snapshot) => {
                takers.clear();
                snapshot.docs.forEach(doc => takers.set(doc.id, doc.data()));
                updateTakersListUI();
            });
            
            // 統計
            onSnapshot(statsCol, (snapshot) => {
                const stats = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                updateStatsListUI(stats);
            });

            // 履歴
            onSnapshot(historyCol, (snapshot) => {
                const history = snapshot.docs.map(doc => doc.data()).sort((a,b) => b.timestamp - a.timestamp);
                updateHistoryListUI(history);
            });
        }

        // --- UI更新関数 ---
        function updateBentoInfoUI() {
            if (currentBento) {
                currentBentoName.textContent = currentBento.name;
                currentBentoStock.textContent = currentBento.current_stock;
                systemMessage.textContent = '食べたい人は「希望する」ボタンを押してください！';
                systemMessage.classList.replace('bg-yellow-100', 'bg-green-100');
                 systemMessage.classList.replace('text-yellow-800', 'text-green-800');
            }
        }
        
        function resetUI() {
            currentBentoName.textContent = '弁当はまだ登録されていません';
            currentBentoStock.textContent = '0';
            systemMessage.textContent = '弁当が登録されると意思表示を開始できます。';
            systemMessage.classList.replace('bg-green-100', 'bg-yellow-100');
            systemMessage.classList.replace('text-green-800', 'text-yellow-800');
            wishList.innerHTML = '';
            takersList.innerHTML = '<p class="text-gray-500">まだ誰も確定していません。</p>';
        }

        function updateWishListUI() {
            wishList.innerHTML = '';
            const areTakersDecided = takers.size > 0;
            const noBento = !currentBento || currentBento.current_stock <= 0;

            MEMBERS.forEach(member => {
                const hasWished = wishes.has(member.id);
                const li = document.createElement('div');
                li.className = `p-3 rounded-lg flex items-center justify-between transition ${hasWished ? 'bg-blue-100' : 'bg-gray-100'}`;
                li.innerHTML = `
                    <span class="font-medium">${member.name}</span>
                    ${hasWished ? '<span class="text-sm font-bold text-blue-600">希望表明済み</span>' : ''}
                    <button data-id="${member.id}" class="wish-btn bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-green-600 btn">希望する</button>
                `;
                wishList.appendChild(li);

                const btn = li.querySelector('.wish-btn');
                if (hasWished || areTakersDecided || noBento) {
                    btn.disabled = true;
                    btn.classList.add('hidden');
                }
            });
        }
        
        function updateTakersListUI() {
            takersList.innerHTML = '';
            if (takers.size === 0) {
                takersList.innerHTML = '<p class="text-gray-500">まだ誰も確定していません。</p>';
                return;
            }

            const sortedTakers = Array.from(takers.values()).sort((a,b) => a.priority - b.priority);
            
            sortedTakers.forEach(taker => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg flex items-center justify-between ${taker.taken ? 'bg-gray-200' : 'bg-yellow-100'}`;
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-800">${taker.name}</span>
                        ${taker.taken ? '<span class="text-xs ml-2 text-green-700">受取済</span>' : ''}
                    </div>
                    <button data-id="${taker.id}" class="take-btn bg-orange-500 text-white text-sm font-bold py-1 px-3 rounded-full hover:bg-orange-600 btn">受け取った</button>
                `;
                takersList.appendChild(div);

                const btn = div.querySelector('.take-btn');
                if (taker.taken) {
                    btn.disabled = true;
                    btn.classList.add('hidden');
                }
            });
        }

        function updateStatsListUI(stats) {
            statsList.innerHTML = '';
            if (!stats || stats.length === 0) {
                 statsList.innerHTML = '<p class="text-gray-500">まだ誰も受け取っていません。</p>';
                 return;
            }

            const sortedStats = stats.sort((a,b) => b.total_taken - a.total_taken);
            sortedStats.forEach(stat => {
                 const member = MEMBERS.find(m => m.id === stat.id);
                 if (member) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm';
                    div.innerHTML = `
                        <span>${member.name}</span>
                        <span class="font-bold bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${stat.total_taken} 回</span>
                    `;
                    statsList.appendChild(div);
                }
            });
        }
        
        function updateHistoryListUI(history) {
             historyList.innerHTML = '';
             if (!history || history.length === 0) {
                 historyList.innerHTML = '<p class="text-gray-500">まだ受け取り履歴はありません。</p>';
                 return;
             }
             history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-1.5 bg-gray-50 rounded';
                const date = new Date(item.timestamp.seconds * 1000).toLocaleString('ja-JP');
                div.textContent = `${date}: ${item.name}さんが${item.bento_name}を受け取り`;
                historyList.appendChild(div);
             });
        }


        // --- イベントハンドラ ---
        
        // 弁当登録
        registerBentoBtn.addEventListener('click', async () => {
            const name = bentoNameInput.value.trim();
            const stock = parseInt(bentoStockInput.value, 10);

            if (!name || isNaN(stock) || stock <= 0) {
                alert('有効な弁当の名前と個数を入力してください。');
                return;
            }

            // 古いデータを全削除
            const batch = writeBatch(db);
            const wishesSnapshot = await getDoc(collection(db, 'artifacts', appId, 'public', 'data', 'wishes'));
            const takersSnapshot = await getDoc(collection(db, 'artifacts', appId, 'public', 'data', 'takers'));
            wishes.forEach((val, key) => batch.delete(doc(wishesCol, key)));
            takers.forEach((val, key) => batch.delete(doc(takersCol, key)));
            
            // 新しい弁当情報をセット
            const newBentoData = {
                name: name,
                initial_stock: stock,
                current_stock: stock,
                timestamp: new Date()
            };
            batch.set(bentoDocRef, newBentoData);

            await batch.commit();
            
            bentoNameInput.value = '';
            bentoStockInput.value = '';
            alert(`${name}を${stock}個で登録しました。`);
        });

        // 意思表示
        wishList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('wish-btn')) {
                const userId = e.target.dataset.id;
                const member = MEMBERS.find(m => m.id === userId);
                if (member) {
                    e.target.disabled = true;
                    await setDoc(doc(wishesCol, userId), {
                        name: member.name,
                        priority: member.priority,
                        timestamp: new Date()
                    });
                }
            }
        });
        
        // 受け取り確定
        takersList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('take-btn')) {
                const takerId = e.target.dataset.id;
                e.target.disabled = true;
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const bentoSnap = await transaction.get(bentoDocRef);
                        if (!bentoSnap.exists() || bentoSnap.data().current_stock <= 0) {
                            throw "弁当の在庫がありません。";
                        }
                        
                        const takerSnap = await transaction.get(doc(takersCol, takerId));
                        if (!takerSnap.exists() || takerSnap.data().taken) {
                             throw "すでに受け取り済みです。";
                        }

                        // 1. 在庫を減らす
                        const newStock = bentoSnap.data().current_stock - 1;
                        transaction.update(bentoDocRef, { current_stock: newStock });

                        // 2. Takerを更新 (taken: true)
                        transaction.update(doc(takersCol, takerId), { taken: true });

                        // 3. 統計を更新
                        const statDocRef = doc(statsCol, takerId);
                        const statSnap = await transaction.get(statDocRef);
                        const newTotal = (statSnap.exists() ? statSnap.data().total_taken : 0) + 1;
                        transaction.set(statDocRef, { total_taken: newTotal, name: takerSnap.data().name }, { merge: true });

                        // 4. 履歴に追加
                        const historyDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'history')); // 新規ドキュメント
                        transaction.set(historyDocRef, {
                            userId: takerId,
                            name: takerSnap.data().name,
                            bento_name: bentoSnap.data().name,
                            timestamp: new Date()
                        });
                    });
                    console.log("受け取り処理が正常に完了しました。");
                } catch (error) {
                    console.error("受け取り処理中にエラーが発生しました: ", error);
                    alert("エラーが発生しました。ページをリロードして再度お試しください。");
                }
            }
        });

        // --- コアロジック ---

        async function determineTakers() {
            if (determinationInProgress || !currentBento || takers.size > 0 || wishes.size === 0) {
                return;
            }

            const stock = currentBento.initial_stock;
            const wishingMembers = Array.from(wishes.values()).sort((a,b) => a.priority - b.priority);

            if (wishingMembers.length >= stock) {
                determinationInProgress = true;
                const newTakers = wishingMembers.slice(0, stock);

                const batch = writeBatch(db);
                newTakers.forEach(taker => {
                    const member = MEMBERS.find(m => m.priority === taker.priority);
                    if(member){
                         batch.set(doc(takersCol, member.id), {
                            name: member.name,
                            priority: member.priority,
                            taken: false,
                            timestamp: new Date()
                        });
                    }
                });

                try {
                    await batch.commit();
                    console.log("確定者が決定しました。");
                    systemMessage.textContent = '本日の弁当GET組が確定しました！おめでとうございます！';
                } catch(error) {
                    console.error("確定者の書き込みに失敗:", error);
                } finally {
                    determinationInProgress = false;
                }
            }
        }

        // --- 初期化 ---
        window.onload = () => {
            setupRealtimeListeners();
        };

    </script>
</body>
</html>
